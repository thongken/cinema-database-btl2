import { Prisma } from "@prisma/client";
import { handleErrorResponse } from "../helpers/handleResponse.js";

export const errorHandler = (err, req, res, next) => {
    if (err instanceof BadRequestError){
        err.code = 400;
    }
    else if (err instanceof ForbiddenError){
        err.code = 403;
    }
    else if (err instanceof UnAuthorizedError){
        err.code = 401;
    }
    else if (err instanceof NotFoundError){
        err.code = 404;
    }
    else if (err instanceof Prisma.PrismaClientKnownRequestError) {

        // Mã lỗi Prisma: https://www.prisma.io/docs/reference/api-reference/error-reference
        switch (err.code) {
            case 'P2002': 
                err.code = 409;
                err.message = "Dữ liệu bị trùng (unique constraint).";
                break;

            case 'P2003': 
                err.code = 409;
                err.message = "Foreign key không hợp lệ.";
                break;

            case 'P2025': 
                err.code = 404;
                err.message = "Không tìm thấy bản ghi.";
                break;

            default:
                err.code = 500;
        }
    }
    else if (err instanceof Prisma.PrismaClientUnknownRequestError) {
        err.code = 500; 
    }
    else if (err instanceof Prisma.PrismaClientValidationError) {
        err.code = 400;
        err.message = "Dữ liệu gửi lên không hợp lệ.";
    }
    else {
        err.code = err.code || 500;
    }

    const resError = handleErrorResponse(err.code, err.message);
    res.status(resError.code).json(resError);
};


export class BadRequestError extends Error{
    constructor(message = "BadRequestError"){
        super(message);
        this.code = 400
    }
}

export class ForbiddenError extends Error{
    constructor(message = "ForbiddenError"){
        super(message);
        this.code = 403;
    }
}

export class UnAuthorizedError extends Error{
    constructor(message = "UnAuthorizedError"){
        super(message);
        this.code = 401;
    }
}

export class NotFoundError extends Error{
    constructor(message = "NotFoundError"){
        super(message);
        this.code = 404;
    }
}

export class InternalServerError extends Error{
    constructor(message = "InternalServerError"){
        super(message);
        this.code = 500;
    }
}